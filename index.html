<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Book Online at Brook Hollow Family Dentistry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f3efe8;
        margin: 0;
        padding: 0;
        color: #1f2a24;
      }
      .container {
        max-width: 600px;
        margin: 40px auto;
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h2 {
        margin-top: 0;
        color: #6f8f7a;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
      }
      select,
      input {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #cfd6d1;
        font-size: 15px;
      }
      select:focus,
      input:focus {
        outline: none;
        border-color: #6f8f7a;
      }
      button {
        margin-top: 30px;
        background: #6f8f7a;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }
      button:hover {
        background: #5f7f6a;
      }
      .button-row {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        gap: 10px;
      }
      .button-row button {
        width: 48%;
      }
      .back-btn {
        background: #d9d4cc;
        color: #1f2a24;
      }
      .back-btn:hover {
        background: #cfc9bf;
      }
      .hidden {
        display: none;
      }
      .note {
        font-size: 13px;
        color: #555;
        margin-top: 8px;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }
      .logo {
        max-width: 60px;
        width: 60px;
        height: auto;
      }
      .brand-text {
        font-size: 14px;
        font-weight: 600;
        color: #1f2a24;
        opacity: 0.85;
      }
      .confirm-box {
        background: #f7f3ed;
        border: 1px solid #e3ddd3;
        padding: 14px;
        border-radius: 10px;
        margin-top: 15px;
      }
      .small {
        font-size: 13px;
        color: #444;
      }
      .errorline {
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        background: #fff3f3;
        border: 1px solid #ffd0d0;
        color: #8a1f1f;
        font-size: 13px;
        display: none;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .warning {
        margin-bottom: 18px;
        padding: 14px;
        border-radius: 10px;
        background: #fff8e6;
        border: 1px solid #ffe2a8;
        color: #5a4300;
        display: none;
      }
      .warning b {
        display: block;
        margin-bottom: 6px;
      }
      .warning a {
        display: inline-block;
        margin-top: 10px;
        background: #6f8f7a;
        color: #fff;
        padding: 10px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
      }
      .warning a:hover {
        background: #5f7f6a;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- ✅ Local-file / Outlook-preview warning -->
      <div id="hostWarning" class="warning">
        <b>This page was opened as a file/attachment.</b>
        iPhone browsers block online scheduling requests from this mode (ex: Outlook preview / “edge://external-file”).
        <br />
        Please open the hosted booking link instead:
        <br />
        <a id="hostedLink" href="#" target="_blank" rel="noopener">Open the online booking page</a>
      </div>

      <div class="brand">
        <img src="./FoxDentLogo.png" alt="FoxDent" class="logo" />
        <div class="brand-text">Powered by FoxDent</div>
      </div>

      <!-- STEP 1 -->
      <div id="step1">
        <h2>Welcome to Brook Hollow Family Dentistry</h2>
        <label>Are you a new or existing patient?</label>
        <select id="patientStatus">
          <option value="">Select one</option>
          <option value="new">New Patient</option>
          <option value="existing">Existing Patient</option>
        </select>
        <button onclick="goToStep2()">Next</button>
      </div>

      <!-- STEP 2 -->
      <div id="step2" class="hidden">
        <h2>Appointment Type</h2>
        <label>What are we coming in for today?</label>
        <select id="appointmentType">
          <option value="">Select appointment type</option>
          <option value="emergency">Emergency</option>
          <option value="consult">Consult Exam</option>
          <option value="adult_cleaning">Checkup and Cleaning – Adult</option>
          <option value="child_cleaning">Checkup and Cleaning – Child</option>
        </select>
        <div class="button-row">
          <button class="back-btn" onclick="showStep('step1')">Back</button>
          <button onclick="goToStep3()">Next</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div id="step3" class="hidden">
        <h2>Who is this appointment for?</h2>
        <select id="forWhom">
          <option value="">Select one</option>
          <option value="self">I’m making this appointment for myself</option>
          <option value="other">I’m making this appointment for someone else</option>
        </select>
        <div class="button-row">
          <button class="back-btn" onclick="showStep('step2')">Back</button>
          <button onclick="goToStep4()">Next</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div id="step4" class="hidden">
        <h2>Patient Information</h2>
        <label>First Name</label>
        <input type="text" id="firstName" />
        <label>Last Name</label>
        <input type="text" id="lastName" />
        <label>Date of Birth</label>
        <input type="date" id="dob" />
        <label>Contact Phone Number</label>
        <input type="tel" id="phone" />
        <label>Contact Email</label>
        <input type="email" id="email" />
        <div class="button-row">
          <button class="back-btn" onclick="showStep('step3')">Back</button>
          <button onclick="goToStep5()">Next</button>
        </div>
      </div>

      <!-- STEP 5 -->
      <div id="step5" class="hidden">
        <h2>Insurance Information</h2>
        <label>
          <input type="checkbox" id="noInsurance" onchange="toggleInsurance()" />
          I don’t have insurance, I will be paying out of pocket
        </label>

        <div id="insuranceFields">
          <label>Insurance Carrier</label>
          <input type="text" id="insCarrier" />
          <label>Policy Holder Name</label>
          <input type="text" id="insPolicyHolderName" />
          <label>Policy Holder Date of Birth</label>
          <input type="date" id="insPolicyHolderDob" />
          <label>Member ID</label>
          <input type="text" id="insMemberId" />
          <label>Employer / Group Name</label>
          <input type="text" id="insEmployer" />
          <label>Group ID</label>
          <input type="text" id="insGroupId" />
          <label>Postal Code</label>
          <input type="text" id="insZip" />
        </div>

        <div class="button-row">
          <button class="back-btn" onclick="showStep('step4')">Back</button>
          <button onclick="goToStep6()">Next</button>
        </div>
      </div>

      <!-- STEP 6 -->
      <div id="step6" class="hidden">
        <h2>Select Appointment Date & Time</h2>
        <p class="note">
          Available appointments shown below are based on real-time availability.
        </p>

        <label>Select a Date</label>
        <input
          type="date"
          id="appointmentDate"
          onchange="fetchAvailabilityForSelectedDate()"
        />

        <label>Select a Time</label>
        <select id="appointmentTime">
          <option value="">Select a time</option>
        </select>

        <div id="availabilityError" class="errorline"></div>

        <p class="note">
          After clicking "Confirm Appointment" please wait, page will update with
          confirmation.
        </p>

        <div class="button-row">
          <button class="back-btn" onclick="showStep('step5')">Back</button>
          <button onclick="submitRequest()">Confirm Appointment</button>
        </div>
      </div>

      <!-- STEP 7 -->
      <div id="step7" class="hidden">
        <h2>Appointment Confirmed</h2>
        <div class="confirm-box">
          <div id="confirmSummary"></div>
        </div>
        <p class="small" style="margin-top: 12px;">
          If you need to change or cancel, please call the office.
        </p>
        <button onclick="window.location.reload()">Book Another Appointment</button>
      </div>
    </div>

    <script>
      // IMPORTANT: no trailing slash
      const BACKEND_BASE_URL = "https://foxdentscheduling.calcifer6456.workers.dev";

      // ✅ CHANGE THIS to your hosted frontend URL (GitHub Pages / Cloudflare Pages)
      // Example: "https://calcifer6456.github.io/foxdent-scheduler/"
      const HOSTED_FRONTEND_URL = "https://YOUR-HOSTED-FRONTEND-URL-HERE";

      function showStep(stepId) {
        document
          .querySelectorAll('[id^="step"]')
          .forEach((div) => div.classList.add("hidden"));
        document.getElementById(stepId).classList.remove("hidden");
      }

      function setAvailabilityError(msg) {
        const el = document.getElementById("availabilityError");
        if (!msg) {
          el.style.display = "none";
          el.textContent = "";
          return;
        }
        el.style.display = "block";
        el.textContent = msg;
      }

      function isBlockedContext() {
        // Works for: file://, edge://external-file, about:, etc.
        const proto = (location && location.protocol) ? location.protocol.toLowerCase() : "";
        return proto !== "http:" && proto !== "https:";
      }

      // Show warning immediately if opened from attachment/local mode
      (function initHostWarning() {
        if (isBlockedContext()) {
          const warning = document.getElementById("hostWarning");
          const link = document.getElementById("hostedLink");
          link.href = HOSTED_FRONTEND_URL;
          warning.style.display = "block";
        }
      })();

      function goToStep2() {
        const status = document.getElementById("patientStatus").value;
        if (!status) return alert("Please select New Patient or Existing Patient.");
        showStep("step2");
      }

      function goToStep3() {
        const type = document.getElementById("appointmentType").value;
        if (!type) return alert("Please select an appointment type.");
        showStep("step3");
      }

      function goToStep4() {
        const forWhom = document.getElementById("forWhom").value;
        if (!forWhom)
          return alert(
            "Please choose whether this appointment is for yourself or someone else."
          );
        showStep("step4");
      }

      function goToStep5() {
        const first = document.getElementById("firstName").value.trim();
        const last = document.getElementById("lastName").value.trim();
        const dob = document.getElementById("dob").value;
        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();

        if (!first || !last || !dob || !phone || !email) {
          return alert("Please complete all patient information fields.");
        }
        showStep("step5");
      }

      function goToStep6() {
        showStep("step6");
      }

      function toggleInsurance() {
        const noIns = document.getElementById("noInsurance").checked;
        document.getElementById("insuranceFields").style.display = noIns
          ? "none"
          : "block";
      }

      async function fetchAvailabilityForSelectedDate() {
        setAvailabilityError("");

        // ✅ If opened from attachment/local mode, don’t even try
        if (isBlockedContext()) {
          const timeSelect = document.getElementById("appointmentTime");
          timeSelect.innerHTML = '<option value="">Unable to load times</option>';
          setAvailabilityError(
            "This page was opened as a file/attachment (ex: Outlook / edge://external-file).\n" +
            "iPhone browsers block online scheduling requests in this mode.\n\n" +
            "Please open the hosted booking link at the top of this page."
          );
          return;
        }

        const date = document.getElementById("appointmentDate").value;
        const timeSelect = document.getElementById("appointmentTime");
        timeSelect.innerHTML = '<option value="">Loading available times...</option>';
        if (!date) return;

        const apptType = document.getElementById("appointmentType").value;
        const isNewPatient = document.getElementById("patientStatus").value === "new";

        try {
          const ts = Date.now();
          const url =
            `${BACKEND_BASE_URL}/availability?date=${encodeURIComponent(date)}` +
            `&apptType=${encodeURIComponent(apptType)}` +
            `&isNewPatient=${isNewPatient}` +
            `&_ts=${ts}`;

          const res = await fetch(url, {
            method: "GET",
            mode: "cors",
            credentials: "omit",
            cache: "no-store",
          });

          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { ok: false, error: text };
          }

          if (!res.ok || !data.ok) {
            console.error("availability error:", { status: res.status, text, data });
            timeSelect.innerHTML = '<option value="">Unable to load times</option>';
            setAvailabilityError(
              `Unable to load times.\nHTTP ${res.status}\n${String(
                data.error || text || ""
              ).slice(0, 300)}`
            );
            return;
          }

          timeSelect.innerHTML = '<option value="">Select a time</option>';

          if (!data.slots || data.slots.length === 0) {
            timeSelect.innerHTML =
              '<option value="">No available times for this date</option>';
            return;
          }

          data.slots.forEach((slot) => {
            const opt = document.createElement("option");
            opt.value = slot;
            opt.textContent = slot;
            timeSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("availability network error:", err);
          timeSelect.innerHTML = '<option value="">Unable to load times</option>';
          setAvailabilityError(
            `Unable to load times.\nNetwork error:\n${String(err).slice(0, 300)}`
          );
        }
      }

      async function submitRequest() {
        // ✅ If opened from attachment/local mode, block booking too
        if (isBlockedContext()) {
          return alert(
            "This page was opened as a file/attachment (ex: Outlook preview).\n" +
            "Please open the hosted booking link instead."
          );
        }

        const appointmentDate = document.getElementById("appointmentDate").value;
        const appointmentTime = document.getElementById("appointmentTime").value;
        if (!appointmentDate || !appointmentTime)
          return alert("Please select a date and time.");

        const patientStatus = document.getElementById("patientStatus").value;
        const appointmentType = document.getElementById("appointmentType").value;

        const payload = {
          appointmentDate,
          appointmentTime,
          patientStatus,
          appointmentType,
          patient: {
            firstName: document.getElementById("firstName").value.trim(),
            lastName: document.getElementById("lastName").value.trim(),
            dob: document.getElementById("dob").value,
            phone: document.getElementById("phone").value.trim(),
            email: document.getElementById("email").value.trim(),
          },
          insurance: document.getElementById("noInsurance").checked
            ? { noInsurance: true }
            : {
                noInsurance: false,
                carrier: document.getElementById("insCarrier").value.trim(),
                policyHolderName: document
                  .getElementById("insPolicyHolderName")
                  .value.trim(),
                policyHolderDob: document.getElementById("insPolicyHolderDob").value,
                memberId: document.getElementById("insMemberId").value.trim(),
                employer: document.getElementById("insEmployer").value.trim(),
                groupId: document.getElementById("insGroupId").value.trim(),
                zip: document.getElementById("insZip").value.trim(),
              },
        };

        try {
          const res = await fetch(`${BACKEND_BASE_URL}/book`, {
            method: "POST",
            mode: "cors",
            credentials: "omit",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            cache: "no-store",
          });

          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { ok: false, error: text };
          }

          if (!res.ok || !data.ok) {
            console.error("book error:", { status: res.status, data, text });
            return alert(data.error || "Booking failed. Please try again.");
          }

          document.getElementById("confirmSummary").innerHTML = `
            <b>Confirmation:</b> ${data.confirmationId}<br>
            <b>Patient:</b> ${data.patientName}<br>
            <b>Date/Time:</b> ${data.appointmentDate} at ${data.appointmentTime}<br>
          `;
          showStep("step7");
        } catch (err) {
          console.error(err);
          alert("Unable to book appointment right now. Please try again.");
        }
      }
    </script>
  </body>
</html>
